---
// ç”µå½±åˆ—è¡¨é¡µ
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import Card from '../components/Card.astro';

const base = import.meta.env.BASE_URL.replace(/\/$/, ''); // ç§»é™¤å°¾éƒ¨æ–œæ ï¼Œç»Ÿä¸€å¤„ç†

// è·å–æ‰€æœ‰ç”µå½±å¹¶æŒ‰è§‚çœ‹æ—¥æœŸæ’åº
const movies = await getCollection('movies');
const sortedMovies = [...movies].sort((a, b) =>
  new Date(b.data.watchDate).getTime() - new Date(a.data.watchDate).getTime()
);

// è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
const totalMovies = movies.length;
const avgRating = totalMovies > 0
  ? (movies.reduce((sum, movie) => sum + movie.data.rating, 0) / totalMovies).toFixed(1)
  : 0;
const favoriteCount = movies.filter(m => m.data.favorite).length;
---

<Layout title="ç”µå½±æ¸…å•">
  <div class="page-header">
    <h1>ğŸ¬ ç”µå½±æ¸…å•</h1>
    <div class="stats-summary">
      <div class="stat-item">
        <span class="stat-value">{totalMovies}</span>
        <span class="stat-name">æ€»ç”µå½±æ•°</span>
      </div>
      <div class="stat-item">
        <span class="stat-value">{avgRating} â­</span>
        <span class="stat-name">å¹³å‡è¯„åˆ†</span>
      </div>
      <div class="stat-item">
        <span class="stat-value">{favoriteCount}</span>
        <span class="stat-name">æœ€çˆ±ç”µå½±</span>
      </div>
    </div>
  </div>

  {sortedMovies.length === 0 ? (
    <p style="text-align: center; color: var(--color-text-secondary); margin-top: 3rem;">
      æš‚æ— ç”µå½±è®°å½•ï¼Œå¿«å»æ·»åŠ ä½ çš„ç¬¬ä¸€éƒ¨ç”µå½±å§ï¼
    </p>
  ) : (
    <div class="grid">
      {sortedMovies.map(movie => (
        <Card
          title={movie.data.title}
          rating={movie.data.rating}
          date={movie.data.watchDate}
          tags={movie.data.tags}
          href={`${base}/movies/${movie.slug}`}
          cover={movie.data.cover}
          favorite={movie.data.favorite}
          meta={`${movie.data.director} Â· ${movie.data.year}`}
        />
      ))}
    </div>
  )}
</Layout>

<style>
  .page-header {
    margin-bottom: 2rem;
  }

  .stats-summary {
    display: flex;
    gap: 2rem;
    flex-wrap: wrap;
    margin-top: 1.5rem;
    padding: 1.5rem;
    background-color: var(--color-bg-secondary);
    border-radius: var(--radius);
  }

  .stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--color-primary);
  }

  .stat-name {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    margin-top: 0.25rem;
  }

  @media (max-width: 768px) {
    .stats-summary {
      gap: 1rem;
      justify-content: center;
    }
  }
</style>
