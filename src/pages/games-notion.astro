---
// æ¸¸æˆåˆ—è¡¨é¡µ - ä» Notion è·å–æ•°æ®
import Layout from '../layouts/Layout.astro';
import { getGamesFromNotion } from '../lib/notion';

const base = import.meta.env.BASE_URL.replace(/\/$/, '');

// ä» Notion è·å–æ‰€æœ‰æ¸¸æˆ
const games = await getGamesFromNotion();

// è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
const totalGames = games.length;
const avgRating = totalGames > 0
  ? (games.reduce((sum, game) => sum + game.rating, 0) / totalGames).toFixed(1)
  : 0;
const completedGames = games.filter(g => g.status === 'å·²å®Œæˆ').length;
---

<Layout title="æ¸¸æˆæ¸…å•">
  <div class="page-header">
    <h1>ğŸ® æ¸¸æˆæ¸…å• (Notion æ•°æ®æº)</h1>
    <div class="stats-summary">
      <div class="stat-item">
        <span class="stat-value">{totalGames}</span>
        <span class="stat-name">æ€»æ¸¸æˆæ•°</span>
      </div>
      <div class="stat-item">
        <span class="stat-value">{completedGames}</span>
        <span class="stat-name">å·²å®Œæˆ</span>
      </div>
      <div class="stat-item">
        <span class="stat-value">{avgRating} â­</span>
        <span class="stat-name">å¹³å‡è¯„åˆ†</span>
      </div>
    </div>
  </div>

  {games.length === 0 ? (
    <p style="text-align: center; color: var(--color-text-secondary); margin-top: 3rem;">
      æš‚æ— æ¸¸æˆè®°å½•ï¼Œå¿«å» Notion æ·»åŠ ä½ çš„ç¬¬ä¸€ä¸ªæ¸¸æˆå§ï¼
    </p>
  ) : (
    <div class="grid">
      {games.map(game => (
        <a href={`${base}/games-notion/${game.slug}`} class="card">
          {game.cover && <img src={game.cover} alt={game.title} class="card-cover" />}
          <div class="card-content">
            <h2>
              {game.title}
              {game.favorite && <span class="favorite-badge">â¤ï¸ æœ€çˆ±</span>}
            </h2>
            <div class="card-rating">{'â­'.repeat(game.rating)}</div>
            <div class="card-meta">
              {game.platform} Â· {game.status}
            </div>
            <div class="card-meta">ğŸ“… {game.completedDate}</div>
            {game.tags.length > 0 && (
              <div class="card-tags">
                {game.tags.map(tag => (
                  <span class="tag">{tag}</span>
                ))}
              </div>
            )}
          </div>
        </a>
      ))}
    </div>
  )}
</Layout>

<style>
  .page-header {
    margin-bottom: 2rem;
  }

  .stats-summary {
    display: flex;
    gap: 2rem;
    flex-wrap: wrap;
    margin-top: 1.5rem;
    padding: 1.5rem;
    background-color: var(--color-bg-secondary);
    border-radius: var(--radius);
  }

  .stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--color-primary);
  }

  .stat-name {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    margin-top: 0.25rem;
  }

  @media (max-width: 768px) {
    .stats-summary {
      gap: 1rem;
    }

    .stat-item {
      flex: 1 1 calc(50% - 0.5rem);
      min-width: 100px;
    }
  }
</style>
