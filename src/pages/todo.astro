---
import Layout from '../layouts/Layout.astro';
---

<Layout title="æ¯æ—¥æ‰“å¡">
  <div class="todo-container">
    <h1>ğŸ“‹ ä»Šæ—¥æ‰“å¡</h1>
    <p class="date-display" id="dateDisplay"></p>

    <div class="loading" id="loading">åŠ è½½ä¸­...</div>

    <form id="todoForm" style="display: none;">
      <!-- ä»Šæ—¥çŠ¶æ€ -->
      <section class="status-section">
        <h2>ä»Šæ—¥çŠ¶æ€</h2>
        <div class="form-group">
          <label for="weight">ä½“é‡ (kg)ï¼š</label>
          <input type="number" id="weight" step="0.1" placeholder="ä¾‹å¦‚ï¼š65.5" />
        </div>
        <div class="form-group">
          <label for="remark">å¤‡æ³¨ï¼š</label>
          <textarea id="remark" rows="3" placeholder="ä»Šå¤©çš„çŠ¶æ€å¦‚ä½•ï¼Ÿ"></textarea>
        </div>
      </section>

      <!-- æ‰“å¡æ¸…å• -->
      <section class="checklist-section">
        <h2>æ‰“å¡æ¸…å•</h2>
        <div class="checkbox-group">
          <label>
            <input type="checkbox" id="momo" />
            <span>å¢¨å¢¨èƒŒå•è¯</span>
          </label>
        </div>
        <div class="checkbox-group">
          <label>
            <input type="checkbox" id="pushup" />
            <span>ä¿¯å§æ’‘ä¸€ç»„</span>
          </label>
        </div>
        <div class="checkbox-group">
          <label>
            <input type="checkbox" id="squat" />
            <span>æ·±è¹²ä¸€ç»„</span>
          </label>
        </div>
        <div class="checkbox-group">
          <label>
            <input type="checkbox" id="pullup" />
            <span>æŠ“æ  3 æ¬¡</span>
          </label>
        </div>
        <div class="checkbox-group">
          <label>
            <input type="checkbox" id="standing" />
            <span>ç«™æ¡©</span>
          </label>
        </div>
      </section>

      <div class="button-group">
        <button type="submit" class="btn-primary">ğŸ’¾ ä¿å­˜</button>
        <a href="/todo-history" class="btn-secondary">ğŸ“œ æŸ¥çœ‹å†å²</a>
      </div>
    </form>

    <div class="error-message" id="errorMessage" style="display: none;"></div>
    <div class="success-message" id="successMessage" style="display: none;">ä¿å­˜æˆåŠŸï¼</div>
  </div>
</Layout>

<script>
  // è·å–ä»Šå¤©çš„æ—¥æœŸ YYYY-MM-DD
  function getTodayDate() {
    const today = new Date();
    return today.toISOString().split('T')[0];
  }

  // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
  function formatDateDisplay(dateStr: string) {
    const date = new Date(dateStr);
    const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
    const weekday = weekdays[date.getDay()];
    return `${dateStr} ${weekday}`;
  }

  // åŠ è½½ä»Šæ—¥æ•°æ®
  async function loadTodayTodo() {
    const loading = document.getElementById('loading');
    const form = document.getElementById('todoForm') as HTMLFormElement;
    const errorMessage = document.getElementById('errorMessage');
    const dateDisplay = document.getElementById('dateDisplay');

    const today = getTodayDate();

    if (dateDisplay) {
      dateDisplay.textContent = formatDateDisplay(today);
    }

    try {
      const response = await fetch(`/api/todo-today?date=${today}`);
      const data = await response.json();

      if (loading) loading.style.display = 'none';
      if (form) form.style.display = 'block';

      if (data) {
        // å¡«å……è¡¨å•æ•°æ®
        (document.getElementById('weight') as HTMLInputElement).value = data.weight || '';
        (document.getElementById('remark') as HTMLTextAreaElement).value = data.remark || '';
        (document.getElementById('momo') as HTMLInputElement).checked = data.momo || false;
        (document.getElementById('pushup') as HTMLInputElement).checked = data.pushup || false;
        (document.getElementById('squat') as HTMLInputElement).checked = data.squat || false;
        (document.getElementById('pullup') as HTMLInputElement).checked = data.pullup || false;
        (document.getElementById('standing') as HTMLInputElement).checked = data.standing || false;
      }
    } catch (error) {
      console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
      if (loading) loading.style.display = 'none';
      if (errorMessage) {
        errorMessage.textContent = 'åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
        errorMessage.style.display = 'block';
      }
    }
  }

  // ä¿å­˜æ•°æ®
  async function saveTodo(event: Event) {
    event.preventDefault();

    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');

    const todoData = {
      date: getTodayDate(),
      weight: parseFloat((document.getElementById('weight') as HTMLInputElement).value) || undefined,
      remark: (document.getElementById('remark') as HTMLTextAreaElement).value || undefined,
      momo: (document.getElementById('momo') as HTMLInputElement).checked,
      pushup: (document.getElementById('pushup') as HTMLInputElement).checked,
      squat: (document.getElementById('squat') as HTMLInputElement).checked,
      pullup: (document.getElementById('pullup') as HTMLInputElement).checked,
      standing: (document.getElementById('standing') as HTMLInputElement).checked,
    };

    try {
      const response = await fetch('/api/todo-update', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(todoData),
      });

      if (response.ok) {
        if (successMessage) {
          successMessage.style.display = 'block';
          setTimeout(() => {
            successMessage.style.display = 'none';
          }, 3000);
        }
      } else {
        throw new Error('ä¿å­˜å¤±è´¥');
      }
    } catch (error) {
      console.error('ä¿å­˜å¤±è´¥:', error);
      if (errorMessage) {
        errorMessage.textContent = 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•';
        errorMessage.style.display = 'block';
      }
    }
  }

  // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
  document.addEventListener('DOMContentLoaded', () => {
    loadTodayTodo();

    const form = document.getElementById('todoForm');
    if (form) {
      form.addEventListener('submit', saveTodo);
    }
  });
</script>

<style>
  .todo-container {
    max-width: 600px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  h1 {
    color: var(--color-text);
    margin-bottom: 0.5rem;
    font-size: 2rem;
  }

  .date-display {
    color: var(--color-text-secondary);
    margin-bottom: 2rem;
    font-size: 1.1rem;
  }

  .loading {
    text-align: center;
    padding: 2rem;
    color: var(--color-text-secondary);
  }

  .status-section,
  .checklist-section {
    background: var(--color-bg-secondary);
    padding: 1.5rem;
    border-radius: var(--radius);
    margin-bottom: 1.5rem;
  }

  h2 {
    color: var(--color-text);
    margin-bottom: 1rem;
    font-size: 1.3rem;
  }

  .form-group {
    margin-bottom: 1rem;
  }

  label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--color-text);
    font-weight: 500;
  }

  input[type="number"],
  textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    font-size: 1rem;
    font-family: inherit;
  }

  textarea {
    resize: vertical;
  }

  .checkbox-group {
    margin-bottom: 0.75rem;
  }

  .checkbox-group label {
    display: flex;
    align-items: center;
    cursor: pointer;
    padding: 0.75rem;
    background: white;
    border-radius: var(--radius);
    transition: background 0.2s;
  }

  .checkbox-group label:hover {
    background: #f9fafb;
  }

  input[type="checkbox"] {
    width: 1.25rem;
    height: 1.25rem;
    margin-right: 0.75rem;
    cursor: pointer;
  }

  .checkbox-group span {
    font-size: 1rem;
  }

  .button-group {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
  }

  .btn-primary,
  .btn-secondary {
    flex: 1;
    padding: 1rem;
    border: none;
    border-radius: var(--radius);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    text-decoration: none;
    display: block;
  }

  .btn-primary {
    background: var(--color-primary);
    color: white;
  }

  .btn-primary:hover {
    background: #2563eb;
  }

  .btn-secondary {
    background: white;
    color: var(--color-primary);
    border: 2px solid var(--color-primary);
  }

  .btn-secondary:hover {
    background: var(--color-bg-secondary);
  }

  .error-message,
  .success-message {
    padding: 1rem;
    border-radius: var(--radius);
    margin-top: 1rem;
    text-align: center;
  }

  .error-message {
    background: #fee;
    color: #c00;
  }

  .success-message {
    background: #efe;
    color: #070;
  }
</style>
