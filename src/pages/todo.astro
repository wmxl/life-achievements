---
import Layout from '../layouts/Layout.astro';
---

<Layout title="æ¯æ—¥æ‰“å¡">
  <div class="todo-container">
    <h1>ğŸ“‹ ä»Šæ—¥æ‰“å¡</h1>
    <p class="date-display" id="dateDisplay"></p>

    <div class="loading" id="loading">åŠ è½½ä¸­...</div>

    <form id="todoForm" style="display: none;">
      <section class="today-card">
        <div class="today-grid">
          <div class="status-block">
            <div class="form-group">
              <label for="weight">ä½“é‡ (kg)ï¼š</label>
              <input type="number" id="weight" step="0.1" placeholder="ä¾‹å¦‚ï¼š65.5" />
            </div>
            <div class="form-group">
              <label for="remark">å¤‡æ³¨ï¼š</label>
              <textarea id="remark" rows="3" placeholder="ä»Šå¤©çš„çŠ¶æ€å¦‚ä½•ï¼Ÿ"></textarea>
            </div>
          </div>

          <div class="checklist-block">
            <div class="checkbox-group">
              <label>
                <input type="checkbox" id="momo" />
                <span>å¢¨å¢¨èƒŒå•è¯</span>
              </label>
            </div>
            <div class="checkbox-group">
              <label>
                <input type="checkbox" id="pushup" />
                <span>ä¿¯å§æ’‘ä¸€ç»„</span>
              </label>
            </div>
            <div class="checkbox-group">
              <label>
                <input type="checkbox" id="squat" />
                <span>æ·±è¹²ä¸€ç»„</span>
              </label>
            </div>
            <div class="checkbox-group">
              <label>
                <input type="checkbox" id="pullup" />
                <span>æŠ“æ  3 æ¬¡</span>
              </label>
            </div>
            <div class="checkbox-group">
              <label>
                <input type="checkbox" id="standing" />
                <span>ç«™æ¡©</span>
              </label>
            </div>
          </div>
        </div>
      </section>
    </form>

    <section class="history-section" id="recentHistorySection" style="display: none;">
      <div class="history-title">æœ€è¿‘ 6 å¤©</div>
      <div class="history-list" id="recentHistoryList"></div>
      <div class="history-footer">
        <a href="/todo-history" class="btn-secondary small">æŸ¥çœ‹æ›´å¤š</a>
      </div>
    </section>

    <div class="error-message" id="errorMessage" style="display: none;"></div>
    <div class="success-message" id="successMessage" style="display: none;">å·²è‡ªåŠ¨ä¿å­˜</div>
  </div>
</Layout>

<script>
  // è·å–ä»Šå¤©çš„æ—¥æœŸ YYYY-MM-DD
  function getTodayDate() {
    const today = new Date();
    return today.toISOString().split('T')[0];
  }

  // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
  function formatDateDisplay(dateStr: string) {
    const date = new Date(dateStr);
    const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
    const weekday = weekdays[date.getDay()];
    return `${dateStr} ${weekday}`;
  }

  // åŠ è½½ä»Šæ—¥æ•°æ®
  async function loadTodayTodo() {
    const loading = document.getElementById('loading');
    const form = document.getElementById('todoForm') as HTMLFormElement;
    const errorMessage = document.getElementById('errorMessage');
    const dateDisplay = document.getElementById('dateDisplay');

    const today = activeDate;

    if (dateDisplay) {
      dateDisplay.textContent = formatDateDisplay(today);
    }

    try {
      const response = await fetch(`/api/todo-today?date=${today}`);
      const data = await response.json();

      if (loading) loading.style.display = 'none';
      if (form) form.style.display = 'block';

      if (data) {
        // å¡«å……è¡¨å•æ•°æ®
        (document.getElementById('weight') as HTMLInputElement).value = data.weight || '';
        (document.getElementById('remark') as HTMLTextAreaElement).value = data.remark || '';
        (document.getElementById('momo') as HTMLInputElement).checked = data.momo || false;
        (document.getElementById('pushup') as HTMLInputElement).checked = data.pushup || false;
        (document.getElementById('squat') as HTMLInputElement).checked = data.squat || false;
        (document.getElementById('pullup') as HTMLInputElement).checked = data.pullup || false;
        (document.getElementById('standing') as HTMLInputElement).checked = data.standing || false;
      }

      dataReady = true;
      lastSavedPayload = JSON.stringify(buildTodoData());
    } catch (error) {
      console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
      if (loading) loading.style.display = 'none';
      if (errorMessage) {
        errorMessage.textContent = 'åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
        errorMessage.style.display = 'block';
      }
    }
  }

  let lastSavedPayload = '';
  let isSaving = false;
  let dataReady = false;
  let activeDate = getTodayDate();

  function resetForm() {
    (document.getElementById('weight') as HTMLInputElement).value = '';
    (document.getElementById('remark') as HTMLTextAreaElement).value = '';
    (document.getElementById('momo') as HTMLInputElement).checked = false;
    (document.getElementById('pushup') as HTMLInputElement).checked = false;
    (document.getElementById('squat') as HTMLInputElement).checked = false;
    (document.getElementById('pullup') as HTMLInputElement).checked = false;
    (document.getElementById('standing') as HTMLInputElement).checked = false;
  }

  function syncDateIfNeeded() {
    const currentDate = getTodayDate();
    if (currentDate === activeDate) return;

    activeDate = currentDate;
    dataReady = false;
    lastSavedPayload = '';

    const loading = document.getElementById('loading');
    const form = document.getElementById('todoForm') as HTMLFormElement;
    if (loading) loading.style.display = 'block';
    if (form) form.style.display = 'none';
    resetForm();
    void loadTodayTodo();
  }

  function buildTodoData() {
    return {
      date: activeDate,
      weight: parseFloat((document.getElementById('weight') as HTMLInputElement).value) || undefined,
      remark: (document.getElementById('remark') as HTMLTextAreaElement).value || undefined,
      momo: (document.getElementById('momo') as HTMLInputElement).checked,
      pushup: (document.getElementById('pushup') as HTMLInputElement).checked,
      squat: (document.getElementById('squat') as HTMLInputElement).checked,
      pullup: (document.getElementById('pullup') as HTMLInputElement).checked,
      standing: (document.getElementById('standing') as HTMLInputElement).checked,
    };
  }

  // ä¿å­˜æ•°æ®
  async function saveTodo() {
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');

    if (!dataReady || isSaving) return;
    syncDateIfNeeded();
    if (!dataReady || isSaving) return;
    const todoData = buildTodoData();
    const payload = JSON.stringify(todoData);
    if (payload === lastSavedPayload) return;

    try {
      isSaving = true;
      const response = await fetch('/api/todo-update', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: payload,
      });

      if (response.ok) {
        lastSavedPayload = payload;
        if (successMessage) {
          successMessage.style.display = 'block';
          setTimeout(() => {
            successMessage.style.display = 'none';
          }, 3000);
        }
      } else {
        throw new Error('ä¿å­˜å¤±è´¥');
      }
    } catch (error) {
      console.error('ä¿å­˜å¤±è´¥:', error);
      if (errorMessage) {
        errorMessage.textContent = 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•';
        errorMessage.style.display = 'block';
      }
    } finally {
      isSaving = false;
    }
  }

  async function loadRecentHistory() {
    const section = document.getElementById('recentHistorySection');
    const list = document.getElementById('recentHistoryList');
    if (!list) return;

    try {
      const response = await fetch('/api/todo-history?limit=10');
      const data = await response.json();
      const today = getTodayDate();
      const recent = Array.isArray(data)
        ? data.filter((item: any) => item?.date && item.date !== today).slice(0, 6)
        : [];

      if (recent.length > 0) {
        list.innerHTML = recent
          .map((item: any) => `
            <div class="history-item">
              <div class="history-header">
                <h3>${formatDateDisplay(item.date)}</h3>
              </div>

              <div class="checklist">
                <div class="check-item ${item.momo ? 'checked' : ''}">
                  <span class="icon">${item.momo ? 'âœ…' : 'â¬œ'}</span>
                  <span>å¢¨å¢¨èƒŒå•è¯</span>
                </div>
                <div class="check-item ${item.pushup ? 'checked' : ''}">
                  <span class="icon">${item.pushup ? 'âœ…' : 'â¬œ'}</span>
                  <span>ä¿¯å§æ’‘ä¸€ç»„</span>
                </div>
                <div class="check-item ${item.squat ? 'checked' : ''}">
                  <span class="icon">${item.squat ? 'âœ…' : 'â¬œ'}</span>
                  <span>æ·±è¹²ä¸€ç»„</span>
                </div>
                <div class="check-item ${item.pullup ? 'checked' : ''}">
                  <span class="icon">${item.pullup ? 'âœ…' : 'â¬œ'}</span>
                  <span>æŠ“æ  3 æ¬¡</span>
                </div>
                <div class="check-item ${item.standing ? 'checked' : ''}">
                  <span class="icon">${item.standing ? 'âœ…' : 'â¬œ'}</span>
                  <span>ç«™æ¡©</span>
                </div>
              </div>

              ${item.weight ? `<span class="weight-badge">âš–ï¸ ${item.weight} kg</span>` : ''}
              ${item.remark ? `<p class="remark">${item.remark}</p>` : ''}
            </div>
          `)
          .join('');

        if (section) section.style.display = 'block';
      } else {
        list.innerHTML = '<div class="history-empty">æš‚æ— è®°å½•</div>';
        if (section) section.style.display = 'block';
      }
    } catch (error) {
      console.error('åŠ è½½å†å²å¤±è´¥:', error);
      list.innerHTML = '<div class="history-empty">åŠ è½½å¤±è´¥</div>';
      if (section) section.style.display = 'block';
    }
  }

  // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
  document.addEventListener('DOMContentLoaded', () => {
    loadTodayTodo();
    loadRecentHistory();
    setInterval(saveTodo, 2000);
    setInterval(syncDateIfNeeded, 60 * 1000);
  });
</script>

<style>
  .todo-container {
    max-width: 1280px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  h1 {
    color: var(--color-text);
    margin-bottom: 0.5rem;
    font-size: 2rem;
  }

  .date-display {
    color: var(--color-text-secondary);
    margin-bottom: 2rem;
    font-size: 1.1rem;
  }

  .loading {
    text-align: center;
    padding: 2rem;
    color: var(--color-text-secondary);
  }

  .today-card {
    background: var(--color-bg-secondary);
    padding: 1rem;
    border-radius: var(--radius);
    margin-bottom: 1.5rem;
  }

  .today-grid {
    display: grid;
    grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
    gap: 1rem;
  }

  .form-group {
    margin-bottom: 1rem;
  }

  label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--color-text);
    font-weight: 500;
  }

  input[type="number"],
  textarea {
    width: 100%;
    padding: 0.6rem;
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    font-size: 0.95rem;
    font-family: inherit;
  }

  textarea {
    resize: vertical;
  }

  .checkbox-group {
    margin-bottom: 0.75rem;
  }

  .checkbox-group label {
    display: flex;
    align-items: center;
    cursor: pointer;
    padding: 0.6rem;
    background: white;
    border-radius: var(--radius);
    transition: background 0.2s;
  }

  .checkbox-group label:hover {
    background: #f9fafb;
  }

  input[type="checkbox"] {
    width: 1.1rem;
    height: 1.1rem;
    margin-right: 0.6rem;
    cursor: pointer;
  }

  .checkbox-group span {
    font-size: 0.95rem;
  }

  .btn-primary,
  .btn-secondary {
    padding: 0.7rem 1rem;
    border: none;
    border-radius: var(--radius);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    text-decoration: none;
    display: block;
  }

  .btn-primary {
    background: var(--color-primary);
    color: white;
  }

  .btn-primary:hover {
    background: #2563eb;
  }

  .btn-secondary {
    background: white;
    color: var(--color-primary);
    border: 2px solid var(--color-primary);
  }

  .btn-secondary:hover {
    background: var(--color-bg-secondary);
  }

  .error-message,
  .success-message {
    padding: 1rem;
    border-radius: var(--radius);
    margin-top: 1rem;
    text-align: center;
  }

  .error-message {
    background: #fee;
    color: #c00;
  }

  .success-message {
    background: #efe;
    color: #070;
  }

  .history-section {
    margin-top: 2rem;
  }

  .history-title {
    color: var(--color-text);
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
  }

  .history-list {
    display: grid;
    grid-template-columns: repeat(6, minmax(0, 1fr));
    gap: 0.75rem;
  }

  .history-item {
    background: var(--color-bg-secondary);
    padding: 1.5rem;
    border-radius: var(--radius);
    border-left: 4px solid var(--color-primary);
  }

  .history-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
  }

  .history-header h3 {
    color: var(--color-text);
    font-size: 1.2rem;
    margin: 0;
  }

  .weight-badge {
    background: var(--color-primary);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.9rem;
    display: inline-block;
    margin-top: 0.75rem;
  }

  .remark {
    color: var(--color-text-secondary);
    margin-bottom: 1rem;
    padding: 0.75rem;
    background: white;
    border-radius: var(--radius);
    font-style: italic;
  }

  .checklist {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 0.5rem;
  }

  .check-item {
    display: flex;
    align-items: center;
    padding: 0.5rem;
    background: white;
    border-radius: var(--radius);
    font-size: 0.95rem;
  }

  .check-item.checked {
    color: #059669;
  }

  .check-item .icon {
    margin-right: 0.5rem;
    font-size: 1.1rem;
  }

  .history-empty {
    color: var(--color-text-secondary);
    text-align: center;
    padding: 0.75rem 0;
  }

  .history-footer {
    margin-top: 1rem;
    display: flex;
    justify-content: flex-end;
  }

  .btn-secondary.small {
    font-size: 0.95rem;
    padding: 0.6rem 1.2rem;
  }

  @media (max-width: 640px) {
    .today-grid {
      grid-template-columns: 1fr;
    }

    .history-list {
      grid-template-columns: 1fr;
    }
  }
</style>
