---
import Layout from '../layouts/Layout.astro';
---

<Layout title="ÊØèÊó•ÊâìÂç°">
  <div class="todo-container">
    <h1>üìã ‰ªäÊó•ÊâìÂç°</h1>
    <p class="date-display" id="dateDisplay"></p>

    <div class="loading" id="loading">Âä†ËΩΩ‰∏≠...</div>

    <form id="todoForm" style="display: none;">
      <section class="today-card">
        <div class="today-grid">
          <div class="status-block">
            <div class="form-group">
              <label for="weight">‰ΩìÈáç (kg)Ôºö</label>
              <input type="number" id="weight" step="0.1" placeholder="‰æãÂ¶ÇÔºö65.5" />
            </div>
            <div class="form-group">
              <label for="remark">Â§áÊ≥®Ôºö</label>
              <textarea id="remark" rows="3" placeholder="‰ªäÂ§©ÁöÑÁä∂ÊÄÅÂ¶Ç‰ΩïÔºü"></textarea>
            </div>
          </div>

          <div class="checklist-block">
            <div class="checkbox-group">
              <label>
                <input type="checkbox" id="momo" />
                <span>Â¢®Â¢®ËÉåÂçïËØç</span>
              </label>
            </div>
            <div class="checkbox-group">
              <label>
                <input type="checkbox" id="pushup" />
                <span>‰øØÂçßÊíë‰∏ÄÁªÑ</span>
              </label>
            </div>
            <div class="checkbox-group">
              <label>
                <input type="checkbox" id="squat" />
                <span>Ê∑±Ëπ≤‰∏ÄÁªÑ</span>
              </label>
            </div>
            <div class="checkbox-group">
              <label>
                <input type="checkbox" id="pullup" />
                <span>ÊäìÊù† 3 Ê¨°</span>
              </label>
            </div>
            <div class="checkbox-group">
              <label>
                <input type="checkbox" id="standing" />
                <span>Á´ôÊ°©</span>
              </label>
            </div>
          </div>
        </div>
      </section>
    </form>

    <section class="history-section" id="recentHistorySection" style="display: none;">
      <div class="history-title">ÊúÄËøë 6 Â§©</div>
      <div class="history-list" id="recentHistoryList"></div>
      <div class="history-footer">
        <a href="/todo-history" class="btn-secondary small">Êü•ÁúãÊõ¥Â§ö</a>
      </div>
    </section>

    <div class="error-message" id="errorMessage" style="display: none;"></div>
    <div class="success-message" id="successMessage" style="display: none;">Â∑≤Ëá™Âä®‰øùÂ≠ò</div>
  </div>
</Layout>

<script>
  // Ëé∑Âèñ‰ªäÂ§©ÁöÑÊó•Êúü YYYY-MM-DD
  function getTodayDate() {
    const today = new Date();
    return today.toISOString().split('T')[0];
  }

  // Ê†ºÂºèÂåñÊó•ÊúüÊòæÁ§∫
  function formatDateDisplay(dateStr: string) {
    const date = new Date(dateStr);
    const weekdays = ['Âë®Êó•', 'Âë®‰∏Ä', 'Âë®‰∫å', 'Âë®‰∏â', 'Âë®Âõõ', 'Âë®‰∫î', 'Âë®ÂÖ≠'];
    const weekday = weekdays[date.getDay()];
    return `${dateStr} ${weekday}`;
  }

  // Âä†ËΩΩ‰ªäÊó•Êï∞ÊçÆ
  async function loadTodayTodo() {
    const loading = document.getElementById('loading');
    const form = document.getElementById('todoForm') as HTMLFormElement;
    const errorMessage = document.getElementById('errorMessage');
    const dateDisplay = document.getElementById('dateDisplay');

    const today = getTodayDate();

    if (dateDisplay) {
      dateDisplay.textContent = formatDateDisplay(today);
    }

    try {
      const response = await fetch(`/api/todo-today?date=${today}`);
      const data = await response.json();

      if (loading) loading.style.display = 'none';
      if (form) form.style.display = 'block';

      if (data) {
        // Â°´ÂÖÖË°®ÂçïÊï∞ÊçÆ
        (document.getElementById('weight') as HTMLInputElement).value = data.weight || '';
        (document.getElementById('remark') as HTMLTextAreaElement).value = data.remark || '';
        (document.getElementById('momo') as HTMLInputElement).checked = data.momo || false;
        (document.getElementById('pushup') as HTMLInputElement).checked = data.pushup || false;
        (document.getElementById('squat') as HTMLInputElement).checked = data.squat || false;
        (document.getElementById('pullup') as HTMLInputElement).checked = data.pullup || false;
        (document.getElementById('standing') as HTMLInputElement).checked = data.standing || false;
      }

      dataReady = true;
      lastSavedPayload = JSON.stringify(buildTodoData());
    } catch (error) {
      console.error('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•:', error);
      if (loading) loading.style.display = 'none';
      if (errorMessage) {
        errorMessage.textContent = 'Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï';
        errorMessage.style.display = 'block';
      }
    }
  }

  let lastSavedPayload = '';
  let isSaving = false;
  let dataReady = false;

  function buildTodoData() {
    return {
      date: getTodayDate(),
      weight: parseFloat((document.getElementById('weight') as HTMLInputElement).value) || undefined,
      remark: (document.getElementById('remark') as HTMLTextAreaElement).value || undefined,
      momo: (document.getElementById('momo') as HTMLInputElement).checked,
      pushup: (document.getElementById('pushup') as HTMLInputElement).checked,
      squat: (document.getElementById('squat') as HTMLInputElement).checked,
      pullup: (document.getElementById('pullup') as HTMLInputElement).checked,
      standing: (document.getElementById('standing') as HTMLInputElement).checked,
    };
  }

  // ‰øùÂ≠òÊï∞ÊçÆ
  async function saveTodo() {
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');

    if (!dataReady || isSaving) return;
    const todoData = buildTodoData();
    const payload = JSON.stringify(todoData);
    if (payload === lastSavedPayload) return;

    try {
      isSaving = true;
      const response = await fetch('/api/todo-update', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: payload,
      });

      if (response.ok) {
        lastSavedPayload = payload;
        if (successMessage) {
          successMessage.style.display = 'block';
          setTimeout(() => {
            successMessage.style.display = 'none';
          }, 3000);
        }
      } else {
        throw new Error('‰øùÂ≠òÂ§±Ë¥•');
      }
    } catch (error) {
      console.error('‰øùÂ≠òÂ§±Ë¥•:', error);
      if (errorMessage) {
        errorMessage.textContent = '‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï';
        errorMessage.style.display = 'block';
      }
    } finally {
      isSaving = false;
    }
  }

  function formatHistorySummary(item: any) {
    const tasks = [];
    if (item.momo) tasks.push('Â¢®Â¢®');
    if (item.pushup) tasks.push('‰øØÂçßÊíë');
    if (item.squat) tasks.push('Ê∑±Ëπ≤');
    if (item.pullup) tasks.push('ÊäìÊù†');
    if (item.standing) tasks.push('Á´ôÊ°©');
    return tasks.length ? tasks.join(' ¬∑ ') : 'Êú™ÊâìÂç°';
  }

  async function loadRecentHistory() {
    const section = document.getElementById('recentHistorySection');
    const list = document.getElementById('recentHistoryList');
    if (!list) return;

    try {
      const response = await fetch('/api/todo-history?limit=6');
      const data = await response.json();

      if (Array.isArray(data) && data.length > 0) {
        list.innerHTML = data
          .map((item: any) => {
            const dateText = formatDateDisplay(item.date);
            const summary = formatHistorySummary(item);
            const weight = item.weight ? `‰ΩìÈáç ${item.weight}kg` : '';
            const remark = item.remark ? item.remark : '';
            const meta = [summary, weight].filter((text) => text).join(' ¬∑ ');
            return `
              <div class="history-item">
                <div class="history-date">${dateText}</div>
                <div class="history-meta">${meta || 'Êó†ËÆ∞ÂΩï'}</div>
                ${remark ? `<div class="history-remark">${remark}</div>` : ''}
              </div>
            `;
          })
          .join('');

        if (section) section.style.display = 'block';
      } else {
        list.innerHTML = '<div class="history-empty">ÊöÇÊó†ËÆ∞ÂΩï</div>';
        if (section) section.style.display = 'block';
      }
    } catch (error) {
      console.error('Âä†ËΩΩÂéÜÂè≤Â§±Ë¥•:', error);
      list.innerHTML = '<div class="history-empty">Âä†ËΩΩÂ§±Ë¥•</div>';
      if (section) section.style.display = 'block';
    }
  }

  // È°µÈù¢Âä†ËΩΩÊó∂ÊâßË°å
  document.addEventListener('DOMContentLoaded', () => {
    loadTodayTodo();
    loadRecentHistory();
    setInterval(saveTodo, 2000);
  });
</script>

<style>
  .todo-container {
    max-width: 600px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  h1 {
    color: var(--color-text);
    margin-bottom: 0.5rem;
    font-size: 2rem;
  }

  .date-display {
    color: var(--color-text-secondary);
    margin-bottom: 2rem;
    font-size: 1.1rem;
  }

  .loading {
    text-align: center;
    padding: 2rem;
    color: var(--color-text-secondary);
  }

  .today-card {
    background: var(--color-bg-secondary);
    padding: 1rem;
    border-radius: var(--radius);
    margin-bottom: 1.5rem;
  }

  .today-grid {
    display: grid;
    grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
    gap: 1rem;
  }

  .form-group {
    margin-bottom: 1rem;
  }

  label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--color-text);
    font-weight: 500;
  }

  input[type="number"],
  textarea {
    width: 100%;
    padding: 0.6rem;
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    font-size: 0.95rem;
    font-family: inherit;
  }

  textarea {
    resize: vertical;
  }

  .checkbox-group {
    margin-bottom: 0.75rem;
  }

  .checkbox-group label {
    display: flex;
    align-items: center;
    cursor: pointer;
    padding: 0.6rem;
    background: white;
    border-radius: var(--radius);
    transition: background 0.2s;
  }

  .checkbox-group label:hover {
    background: #f9fafb;
  }

  input[type="checkbox"] {
    width: 1.1rem;
    height: 1.1rem;
    margin-right: 0.6rem;
    cursor: pointer;
  }

  .checkbox-group span {
    font-size: 0.95rem;
  }

  .btn-primary,
  .btn-secondary {
    padding: 0.7rem 1rem;
    border: none;
    border-radius: var(--radius);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    text-decoration: none;
    display: block;
  }

  .btn-primary {
    background: var(--color-primary);
    color: white;
  }

  .btn-primary:hover {
    background: #2563eb;
  }

  .btn-secondary {
    background: white;
    color: var(--color-primary);
    border: 2px solid var(--color-primary);
  }

  .btn-secondary:hover {
    background: var(--color-bg-secondary);
  }

  .error-message,
  .success-message {
    padding: 1rem;
    border-radius: var(--radius);
    margin-top: 1rem;
    text-align: center;
  }

  .error-message {
    background: #fee;
    color: #c00;
  }

  .success-message {
    background: #efe;
    color: #070;
  }

  .history-section {
    background: var(--color-bg-secondary);
    padding: 1rem;
    border-radius: var(--radius);
    margin-top: 2rem;
  }

  .history-title {
    color: var(--color-text);
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
  }

  .history-list {
    display: grid;
    gap: 0.75rem;
  }

  .history-item {
    background: white;
    border-radius: var(--radius);
    padding: 0.75rem;
    border: 1px solid var(--color-border);
  }

  .history-date {
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: 0.3rem;
  }

  .history-meta {
    color: var(--color-text-secondary);
    font-size: 0.9rem;
  }

  .history-remark {
    margin-top: 0.4rem;
    font-size: 0.9rem;
    color: var(--color-text);
  }

  .history-empty {
    color: var(--color-text-secondary);
    text-align: center;
    padding: 0.75rem 0;
  }

  .history-footer {
    margin-top: 1rem;
    display: flex;
    justify-content: flex-end;
  }

  .btn-secondary.small {
    font-size: 0.95rem;
    padding: 0.6rem 1.2rem;
  }

  @media (max-width: 640px) {
    .today-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
