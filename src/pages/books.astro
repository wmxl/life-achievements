---
// ä¹¦ç±åˆ—è¡¨é¡µ - å®¢æˆ·ç«¯å®æ—¶æ¸²æŸ“
import Layout from '../layouts/Layout.astro';

const base = import.meta.env.BASE_URL.replace(/\/$/, '');
---

<Layout title="ä¹¦ç±æ¸…å•">
  <div class="page-header">
    <h1>ğŸ“š ä¹¦ç±æ¸…å•</h1>
    <div id="stats-summary" class="stats-summary">
      <div class="stat-item">
        <span class="stat-value">-</span>
        <span class="stat-name">æ€»ä¹¦ç±æ•°</span>
      </div>
      <div class="stat-item">
        <span class="stat-value">-</span>
        <span class="stat-name">å¹³å‡è¯„åˆ†</span>
      </div>
      <div class="stat-item">
        <span class="stat-value">-</span>
        <span class="stat-name">æœ€çˆ±ä¹¦ç±</span>
      </div>
    </div>
  </div>

  <div id="loading" style="text-align: center; color: var(--color-text-secondary); margin-top: 3rem;">
    åŠ è½½ä¸­...
  </div>

  <div id="error" style="display: none; text-align: center; color: #ef4444; margin-top: 3rem;"></div>

  <div id="books-grid" class="grid" style="display: none;"></div>
</Layout>

<style is:global>
  .page-header {
    margin-bottom: 2rem;
  }

  .stats-summary {
    display: flex;
    gap: 2rem;
    flex-wrap: wrap;
    margin-top: 1.5rem;
    padding: 1.5rem;
    background-color: var(--color-bg-secondary);
    border-radius: var(--radius);
  }

  .stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--color-primary);
  }

  .stat-name {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    margin-top: 0.25rem;
  }

  .group-section {
    margin-bottom: 3rem;
  }

  .group-title {
    margin: 0 0 1.5rem;
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--color-text);
  }

  .group-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 1rem;
  }

  @media (max-width: 768px) {
    .stats-summary {
      gap: 1rem;
    }

    .stat-item {
      flex: 1 1 calc(50% - 0.5rem);
      min-width: 100px;
    }

    .group-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script is:inline define:vars={{ base }}>
  async function loadBooks() {
    try {
      const response = await fetch('/api/books');
      if (!response.ok) {
        throw new Error('Failed to fetch books');
      }

      const data = await response.json();
      const books = data.books;

      // æ›´æ–°ç»Ÿè®¡
      const totalBooks = books.length;
      const completedBooks = books.filter(b => b.completedDate).length;
      const avgRating = totalBooks > 0
        ? (books.reduce((sum, book) => sum + book.rating, 0) / totalBooks).toFixed(1)
        : 0;

      const statsDiv = document.getElementById('stats-summary');
      if (statsDiv) {
        statsDiv.innerHTML = `
          <div class="stat-item">
            <span class="stat-value">${totalBooks}</span>
            <span class="stat-name">æ€»ä¹¦ç±æ•°</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">${completedBooks}</span>
            <span class="stat-name">å·²å®Œæˆ</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">${avgRating} â­</span>
            <span class="stat-name">å¹³å‡è¯„åˆ†</span>
          </div>
        `;
      }

      // åˆ†ç»„
      const inProgressBooks = books.filter(b => b.startDate && !b.completedDate);
      const notStartedBooks = books.filter(b => !b.startDate && !b.completedDate);
      const completedBooksList = books.filter(b => b.completedDate);

      // æ¸²æŸ“ä¹¦ç±åˆ—è¡¨
      const booksGrid = document.getElementById('books-grid');
      if (booksGrid) {
        if (books.length === 0) {
          booksGrid.innerHTML = '<p style="text-align: center; color: var(--color-text-secondary);">æš‚æ— ä¹¦ç±è®°å½•</p>';
        } else {
          const renderCard = (book) => {
            const dateLines = [
              book.startDate ? `å¼€å§‹: ${book.startDate}` : '',
              book.completedDate ? `å®Œæˆ: ${book.completedDate}` : '',
            ].filter(Boolean);

            return `
              <a href="${base}/books/${book.slug}" class="card">
                ${book.cover ? `<img src="${book.cover}" alt="${book.title}" class="card-cover" />` : ''}
                <div class="card-content">
                  <h2>
                    ${book.title}
                    ${book.favorite ? '<span class="favorite-badge">â¤ï¸ æœ€çˆ±</span>' : ''}
                  </h2>
                  <div class="card-rating">${'â­'.repeat(book.rating)}</div>
                  <div class="card-meta">${book.status}</div>
                  ${dateLines.length > 0 ? `<div class="card-meta">ğŸ“… ${dateLines.join(' Â· ')}</div>` : ''}
                  ${book.tags.length > 0 ? `
                    <div class="card-tags">
                      ${book.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                    </div>
                  ` : ''}
                </div>
              </a>
            `;
          };

          const renderSection = (title, list) => {
            if (list.length === 0) return '';
            return `
              <section class="group-section">
                <h2 class="group-title">${title}</h2>
                <div class="group-grid">
                  ${list.map(renderCard).join('')}
                </div>
              </section>
            `;
          };

          booksGrid.innerHTML = `
            ${renderSection('è¿›è¡Œä¸­', inProgressBooks)}
            ${renderSection('æœªå¼€å§‹', notStartedBooks)}
            ${renderSection('å·²å®Œæˆ', completedBooksList)}
          `;
        }
        booksGrid.style.display = 'block';
      }

      document.getElementById('loading')?.remove();
    } catch (error) {
      console.error('Error loading books:', error);
      const errorDiv = document.getElementById('error');
      if (errorDiv) {
        errorDiv.textContent = 'åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•';
        errorDiv.style.display = 'block';
      }
      document.getElementById('loading')?.remove();
    }
  }

  // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
  loadBooks();
</script>
